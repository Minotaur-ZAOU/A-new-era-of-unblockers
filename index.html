<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewEra</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            background-color: #343a40;
            color: #ffffff;
            padding: 20px;
        }
        
        .header {
            background-color: #6c757d; 
            padding: 20px;
            border-radius: 5px;
        }

        h1 {
            margin-bottom: 0;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
        }

        h2 {
            font-weight: normal;
            font-size: 1.2rem;
        }

        #videoContainer {
            margin-top: 20px;
            border: 1px solid #6c757d;
            border-radius: 5px;
            padding: 10px;
            background-color: #495057;
        }

        #loading {
            display: none; 
        }

        .progress {
            height: 20px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .search-results {
            margin-top: 20px;
        }

        .search-result {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #495057;
            border-radius: 5px;
        }

        .search-result a {
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>NewEra</h1>
            <h2>YouTube動画をPipedに変換</h2>
        </div>
        <div class="input-group mb-3">
            <input type="text" id="youtubeUrl" class="form-control" placeholder="YouTube URLを入力" />
            <div class="input-group-append">
                <button id="convertButton" class="btn btn-primary">変換</button>
            </div>
        </div>
        <div class="input-group mb-3">
            <input type="search" id="searchbox" class="form-control" placeholder="動画を検索" title="検索" />
            <div class="input-group-append">
                <button id="searchButton" class="btn btn-primary">検索</button>
            </div>
        </div>
        <div id="loading" class="text-center">
            <p>読み込み中...</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
        <div id="videoContainer" class="text-center"></div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <script>
        const invidiousApis = [
            // 省略のため同じAPIリストをそのまま使用
        ];

        const serverUrl = 'https://yewtu.be'; // 新しいAPIのURL

        document.getElementById('convertButton').addEventListener('click', async () => {
            // Piped変換ロジック（省略）
        });

        document.getElementById('searchButton').addEventListener('click', async () => {
            const query = document.getElementById('searchbox').value.trim();
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            if (!query) {
                await showMessage('<p class="text-danger">検索クエリを入力してください。</p>', searchResults);
                return;
            }

            await searchVideosOnYewtu(query, searchResults);
        });

        async function searchVideosOnYewtu(query, searchResults) {
            try {
                const apiUrl = `${serverUrl}/api/v1/search?q=${encodeURIComponent(query)}`;
                const response = await fetch(apiUrl);

                if (response.ok) {
                    const results = await response.json();
                    if (results.length > 0) {
                        results.forEach(video => {
                            const resultDiv = document.createElement('div');
                            resultDiv.classList.add('search-result');
                            resultDiv.innerHTML = `<a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">${video.title}</a>`;
                            searchResults.appendChild(resultDiv);
                        });
                    } else {
                        await showMessage('<p class="text-warning">動画が見つかりませんでした。</p>', searchResults);
                        await searchWithAlternativeAPIs(query, searchResults);
                    }
                } else {
                    throw new Error('Yewtuの検索中にエラーが発生しました。');
                }
            } catch (error) {
                console.error('Error searching videos on Yewtu:', error);
                await showMessage('<p class="text-danger">Yewtuからのレスポンスエラー。代替APIを試みます...</p>', searchResults);
                await searchWithAlternativeAPIs(query, searchResults);
            }
        }

        async function searchWithAlternativeAPIs(query, searchResults) {
            for (const api of invidiousApis) {
                try {
                    const apiUrl = `${api}api/v1/search?query=${encodeURIComponent(query)}`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('代替APIエラー');

                    const results = await response.json();
                    results.forEach(video => {
                        const resultDiv = document.createElement('div');
                        resultDiv.classList.add('search-result');
                        resultDiv.innerHTML = `<a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">${video.title}</a>`;
                        searchResults.appendChild(resultDiv);
                    });

                    if (results.length > 0) return; // 成功した場合は終了
                } catch (error) {
                    console.error('Error searching videos with alternative API:', error);
                }
            }

            await showMessage('<p class="text-warning">どのAPIでも動画が見つかりませんでした。</p>', searchResults);
        }

        // 以下は他の関数（extractVideoId, showMessage, handleApiError）を省略しないように
    </script>
</body>
</html>
